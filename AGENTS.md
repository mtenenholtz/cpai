# Repository Guidelines

## Project Structure & Module Organization

- `src/cli.ts` — CLI entrypoint (`init`, `scan`, `copy`, `tui`).
- `src/ui/` — interactive TUI implementation
  - `src/ui/adapter.ts` — UI adapter (Ink-backed)
  - `src/ui/ink/` — Ink components, hooks, and app shell
  - `src/ui/core/` — state, actions, selectors, tree helpers
- `src/lib/` — helpers: `scan.ts` (globs + token counts), `format.ts` (render/pack/XML/tags), `config.ts`, `tokenizer.ts`, `utils.ts`.
- `src/types.ts` — TypeScript types shared across modules.
- `dist/` — compiled JS; do not edit. Generated by `pnpm run build`.
- Optional config files: `.cpairc.json`; ignore rules via `.cpaiignore` plus `.gitignore`.

## Build, Test, and Development Commands

- `pnpm install` — install dependencies (Node ≥ 18.18).
- `pnpm run build` — compile TypeScript to `dist/` via `tsc`.
- `pnpm run dev` — run the CLI in dev mode (`tsx src/cli.ts --help`).
- `pnpm start` — run compiled CLI (`node dist/cli.js`).
- Global link (optional): `pnpm link --global` then use `cpai`.
- Quick examples: `cpai scan . --by-dir`, `cpai copy . --max-tokens 120000`, `cpai tui .`.

### Linting, Formatting, and Type Checks (required during development)

- `pnpm run lint` — run ESLint (ESLint v9 flat config, TS + TSX, type-aware).
- `pnpm run lint:fix` — auto-fix linter issues where possible.
- `pnpm run format` — Prettier write across the repo.
- `pnpm run format:check` — Prettier check only.
- `pnpm run typecheck` — TypeScript `--noEmit` project check.
- `pnpm run check` — runs `lint`, `format:check`, and `typecheck`.

Policy: Always run `pnpm run check` locally before pushing or opening a PR. Keep diffs clean by running `pnpm run lint:fix && pnpm run format` as you iterate.

Note: After making changes that require compilation (TypeScript or build‑affecting config), always run `pnpm run build` (aka `pnpm build`) to refresh `dist/` before using `pnpm start` or the globally linked `cpai`.

## Coding Style & Naming Conventions

- Language: TypeScript (strict), ESM (`type: module`, `moduleResolution: NodeNext`).
- Indentation: 2 spaces; include semicolons; prefer single quotes or consistent string style.
- Exports: prefer named exports; avoid default exports for libraries in `src/lib/`.
- Filenames: lowercase, short; prefer `kebab-case` if multiword (e.g., `file-picker.ts`).
- Types/Interfaces use `PascalCase`; variables/functions use `camelCase`.
- Linters/Formatters: ESLint v9 (flat config in `eslint.config.js`) and Prettier are configured. Prefer minimal rule additions and keep stylistic rules delegated to Prettier.

## Testing Guidelines

- Vitest is configured (see `package.json`).
- Run tests: `pnpm test` (or `pnpm coverage` for HTML/LCOV reports).
- Location: `src/**/*.test.ts` (co-located with sources).
- Naming: mirror source name (e.g., `utils.test.ts`).

## Commit & Pull Request Guidelines

- Use Conventional Commits: `feat(cli): add --xml output`, `fix(scan): handle too-large`, `docs: update README`.
- PRs must include: clear description, rationale, CLI/TUI examples (and screenshots for TUI changes), updated docs (`README.md`/help text), and tests if behavior changes.
- Keep changes focused; do not commit built artifacts in `dist/`.

## Git Branching Strategy

- `main` — stable, protected, and release‑ready. No direct commits. Only merge via PRs with all checks green. Tag releases from `main`.
- `dev` — integration branch for ongoing work. Branch feature/fix work from `dev` and open PRs back into `dev`. Keep `dev` green.
- Feature branches — name by type and scope, e.g. `feat/<scope>-<short-desc>`, `fix/<scope>-<short-desc>`, `chore/…`, `docs/…`, `refactor/…`, `test/…`. Branch from `dev`; delete after merge.
- Hotfixes — for urgent production fixes: branch from `main` as `hotfix/<short-desc>`, open PR to `main`, and after merge, immediately back‑merge `main` into `dev` (or cherry‑pick) to keep them in sync.
- Releases — when `dev` is ready, open a PR from `dev` to `main`. Use the PR description to summarize notable changes. After merge, create a tag if releasing.

Recommended local flow:

```bash
# start new work from latest dev
git switch dev && git pull --ff-only
git switch -c feat/<scope>-<short-desc>

# keep branch current (rebase preferred)
git fetch origin && git rebase origin/dev

# open PR to dev when ready

# hotfix flow (from main)
git switch main && git pull --ff-only
git switch -c hotfix/<short-desc>
# open PR to main, then back-merge main -> dev after merge
```

Rules of thumb:

- Never push directly to `main`. Prefer PRs for all changes.
- Verify `pnpm run check` passes before opening or merging any PR.
- Prefer small, focused PRs into `dev`; avoid long‑lived branches.

## Security & Configuration Tips

- Avoid leaking secrets: review `--include/--exclude`, `.gitignore`, and `.cpaiignore`. Run `cpai scan` before `cpai copy`.
- Large/binary files are skipped by default; adjust via `.cpairc.json` (`maxBytesPerFile`, `exclude`).
